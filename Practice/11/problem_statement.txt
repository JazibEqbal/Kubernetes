### Scenario

Your company is deploying a **production-grade Order Processing Platform** on Kubernetes.
The platform consists of a **stateful backend** that processes orders and stores transactional data locally on disk for durability.
This system must be **highly available**, **fault tolerant**, **secure**, **observable**, and **cost-efficient**.

---
## ğŸ§© Application Characteristics

* Backend is **stateful**
* Each replica **must keep its own persistent data**
* Pods must have **stable network identities**
* Application startup takes **25â€“40 seconds**
* Application **must not receive traffic until fully ready**
* Application **crashes if DB credentials are missing**
* Logs must be written to a **persistent volume**
* Metrics endpoint exposed at `/metrics`
* Health endpoints:

  * `/startup`
  * `/ready`
  * `/health`

---

## ğŸ¯ Infrastructure Constraints

* Kubernetes cluster has:
  * **Multiple nodes**
  * Nodes are labeled:

    ```
    node-type=backend
    ```
* At least **3 backend nodes** are available
* Pods must be **evenly spread across nodes**
* No two replicas should run on the **same node if avoidable**

---

## ğŸ“Œ Requirements

### 1ï¸âƒ£ Namespace Isolation

* Create a dedicated namespace:

  ```
  prod-orders
  ```
* All resources must be deployed inside this namespace

---

### 2ï¸âƒ£ Configuration Management

#### ConfigMap

Create a ConfigMap containing:

* `APP_ENV=production`
* `LOG_LEVEL=INFO`
* `APP_PORT=8080`

Inject all values as **environment variables**

#### Secret

Create a Secret with:

* `DB_USER`
* `DB_PASSWORD`

Requirements:

* Use `type: Opaque`
* Use base64 encoding
* Inject as environment variables
* Application must **fail to start** if secrets are missing

---

### 3ï¸âƒ£ Storage & Persistence

* Use **StatefulSet**, not Deployment
* Each replica must have:

  * Its **own PersistentVolumeClaim**
  * Storage size: `5Gi`
  * `ReadWriteOnce`
* Storage must survive:

  * Pod restarts
  * Pod rescheduling
* Define and use a **StorageClass**
* Volume should be mounted at:

  ```
  /var/lib/orders
  ```

---

### 4ï¸âƒ£ Networking

* Create a **Headless Service**

* Used by the StatefulSet for:

  * Stable DNS
  * Pod identity

* Pods must be reachable as:

  ```
  order-app-0
  order-app-1
  order-app-2
  ```

* Create an additional **ClusterIP Service** for client traffic:

  * Expose port `80`
  * Forward to container port `8080`

---

### 5ï¸âƒ£ Health Probes (Critical)

Configure **all three probes correctly**:

#### Startup Probe

* Allows long startup time
* Prevents premature restarts

#### Readiness Probe

* Ensures pod receives traffic only when ready
* Pod must be removed from Service endpoints on failure

#### Liveness Probe

* Detects stuck or crashed application
* Automatically restarts the container

---

### 6ï¸âƒ£ Affinity & Scheduling (Very Important)

#### Node Affinity

* Pods must run **only** on nodes with:

  ```
  node-type=backend
  ```

#### Pod Anti-Affinity

* Avoid scheduling two replicas on the same node
* Use hostname-based topology

#### Topology Spread Constraints

* Spread replicas evenly across nodes
* Ensure high availability during node failures

---

### 7ï¸âƒ£ Resource Management

* Define **requests and limits** for:

  * CPU
  * Memory
* Ensure:

  * Guaranteed scheduling
  * Protection against noisy neighbors
  * Cost optimization

---

### 8ï¸âƒ£ Observability

* Expose metrics endpoint `/metrics`
* Logs must persist across pod restarts
* Logs written to the persistent volume
* Add a lightweight sidecar container to:

  * Continuously stream logs from the shared volume

---

### 9ï¸âƒ£ Auto Scaling

* Configure **Horizontal Pod Autoscaler (HPA)**:

  * Scale based on CPU utilization
  * Min replicas: `3`
  * Max replicas: `6`
* Ensure autoscaling works correctly with:
  * Resource requests
  * StatefulSet constraints

---

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ClusterIP Service    â”‚  â† prod-client-service
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StatefulSet Pods (order-app-0,1,2)      â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ order-app  â”‚   â”‚ log-sidecarâ”‚        â”‚
â”‚  â”‚ container  â”‚   â”‚ container  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚ shared PVC     â”‚               â”‚
â”‚        â–¼                â–¼               â”‚
â”‚     Persistent Volume (per pod)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Headless Service     â”‚  â† prod-headless-service
â”‚ (Stable DNS per pod) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Uses:
    Namespace â†’ Environment isolation
    ConfigMap â†’ App configuration
    Secret â†’ Sensitive data
    StorageClass â†’ How storage is created
    PVC â†’ Stable storage per pod
    StatefulSet â†’ Stable identity + storage
    Headless Service â†’ Pod DNS identity
    ClusterIP Service â†’ Client traffic
    Sidecar â†’ Log processing
    Probes â†’ Health & traffic control
    Affinity â†’ Placement rules
    HPA â†’ Auto-scaling

StatefulSet
â”‚
â””â”€â”€ creates Pods with label: app=production
                â”‚
                â–¼
Client Service watches for label: app=production
                â”‚
                â–¼
Automatically routes traffic to those Pods
